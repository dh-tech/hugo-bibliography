<style>
    .apa-citation {
        margin-bottom: 1rem;
        text-indent: -2rem;
        padding-left: 2rem;
    }
</style>


{{ $onlyCited := .IsNamedParams | and (eq (.Get "cited") "true") }}
{{ $citedTitles := .Page.Scratch.Get "cited_titles" | default (slice) }}

{{- range site.Data.bibliography }}
{{ $key := .title }}
{{- if eq .itemType "journalArticle"}}

{{- if or (not $onlyCited) (in $citedTitles .title) }}

<p class="apa-citation">
    {{- $authors := slice -}}
    {{- range .creators }}
    {{- if eq .creatorType "author" }}
    {{- $firstInitial := "" -}}
    {{- if .firstName }}
    {{- $firstInitial = print (substr .firstName 0 1) "." }}
    {{- end }}
    {{- if .lastName }}
    {{- $name := printf "%s, %s" .lastName $firstInitial }}
    {{- $authors = $authors | append $name }}
    {{- end }}
    {{- end }}
    {{- end }}
    {{- $authorStr := delimit $authors ", " -}}

    {{- $sortedEntries := sort $entries "authorStr" -}}

    {{- range $sortedEntries }}
    {{- $data := .entry }}
    {{- $authorStr := .authorStr }}

    {{- $year := "" -}}
    {{- with $data.date }}
    {{- $splitDate := split . "-" }}
    {{- if gt (len $splitDate) 0 }}
    {{- $year = index $splitDate 0 }}
    {{- end }}
    {{- end }}

    {{- $title := $data.title | markdownify | plainify }}
    {{- $journal := $data.publicationTitle }}
    {{- $volume := $data.volume }}
    {{- $issue := $data.issue }}
    {{- $pages := $data.pages }}
    {{- $doi := $data.DOI }}

    {{- $citation := printf "%s (%s). %s. <i>%s</i>, <i>%s</i>(%s), %s. https://doi.org/%s" $authorStr $year $title
    $journal $volume $issue $pages $doi }}

    {{ $citation | safeHTML }}
</p>
{{- end}}
{{- end }}
{{- end }}