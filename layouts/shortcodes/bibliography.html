<style>
    .apa-citation {
        margin-bottom: 1rem;
        text-indent: -2rem;
        padding-left: 2rem;
    }
</style>

{{- $citations := slice -}}

{{- $context := . }}
{{- $onlyCited := and $context.IsNamedParams (eq ($context.Get "cited") "true") }}
{{- $citedTitles := $context.Page.Scratch.Get "cited_titles" | default (slice) }}

{{- $hasFilters := and $context.IsNamedParams (gt (len $context.Params) 0) }}

{{- range $entry := site.Data.bibliography }}
    {{- $include := true }}

    {{- if $hasFilters }}
        {{- range $key, $val := $context.Params }}
            {{- if ne $key "cited" }}
                {{- $entryVal := index $entry $key }}
                {{- if not (eq $entryVal $val) }}
                    {{- $include = false }}
                {{- end }}
            {{- end }}
        {{- end }}
    {{- end }}

    {{ warnf "entry title: %s include: %v" $entry.title $include }}

    {{- if and $include (or (not $onlyCited) (in $citedTitles $entry.title)) }}
            {{- $authors := slice }}
            {{- range $entry.creators }}
                {{- if eq .creatorType "author" }}
                    {{- $firstInitial := "" }}
                    {{- if .firstName }}
                        {{- $firstInitial = printf "%s." (substr .firstName 0 1) }}
                    {{- end }}
                    {{- if .lastName }}
                        {{- $name := printf "%s, %s" .lastName $firstInitial }}
                        {{- $authors = $authors | append $name }}
                    {{- end }}
                {{- end }}
            {{- end }}

            {{- $authorStr := delimit $authors ", " }}
            {{- if ge (len $authors) 3 }}
                {{- $authorStr = printf "%s et al." (index $authors 0) }}
            {{- end }}
            {{- $citation := dict "authorStr" $authorStr "citation" $entry -}}
            {{- $citations = $citations | append $citation }}
    {{- end }}
{{- end }}
{{- $sortedCitations := sort $citations "authorStr" -}}

{{- $metaTags := slice }}

{{- range $sortedCitations }}
    {{- $data := .citation }}
    {{- $authorStr := .authorStr }}

    {{- $year := "" }}
    {{- with $data.date }}
        {{- $parts := split . "-" }}
        {{- if gt (len $parts) 0 }}
            {{- $year = index $parts 0 }}
        {{- end }}
    {{- end }}

    {{- $title := $data.title | markdownify | plainify }}
    {{- $journal := $data.publicationTitle }}
    {{- $volume := $data.volume }}
    {{- $issue := $data.issue }}
    {{- $pages := $data.pages }}
    {{- $doi := $data.DOI }}

    {{/* Build HTML meta tags */}}
    {{- $entryMeta := slice
        (printf `<meta name="citation_title" content="%s">` $title)
        (printf `<meta name="citation_journal_title" content="%s">` $journal)
        (printf `<meta name="citation_volume" content="%s">` $volume)
        (printf `<meta name="citation_issue" content="%s">` $issue)
        (printf `<meta name="citation_firstpage" content="%s">` (index (split $pages "-") 0))
        (printf `<meta name="citation_lastpage" content="%s">` (index (split $pages "-") 1))
        (printf `<meta name="citation_publication_date" content="%s">` $year)
        (printf `<meta name="citation_doi" content="%s">` $doi)
    }}

    {{- $metaTags = $metaTags | append $entryMeta }}

    {{- $citationText := printf "%s (%s). %s. <i>%s</i>, <i>%s</i>(%s), %s. <a href="https://doi.org/%s">https://doi.org/%s</a>"
        $authorStr $year $title
        $journal $volume $issue $pages $doi $doi }}
    
    <p class="apa-citation">{{ $citation | safeHTML }}</p>
{{- end }}

{{- .Page.Scratch.Set "citation_meta_tags" $metaTags }}