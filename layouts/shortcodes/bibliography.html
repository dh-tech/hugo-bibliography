<style>
    .apa-citation {
        margin-bottom: 1rem;
        text-indent: -2rem;
        padding-left: 2rem;
    }
</style>

{{- $citations := slice -}}

{{- $context := . }}
{{- $onlyCited := and $context.IsNamedParams (eq ($context.Get "cited") "true") }}
{{- $citedTitles := $context.Page.Scratch.Get "cited_titles" | default (slice) }}
{{- $hasFilters := and $context.IsNamedParams (gt (len $context.Params) 0) }}
{{- $authorParam := $context.Get "authorNum" | default "3" }}
{{- $authorNum := int $authorParam }}

{{ $remote := resources.GetRemote "https://api.zotero.org/groups/5010351/items?format=json" }}
{{ with $remote }}
  {{ $data := .Content | transform.Unmarshal }}
  {{ range $data }}
{{ $entry := .data }}

<!-- determines if entry should be included based on filters, checks if value is anywhere in the key -->
{{- $include := true }}
{{- if $hasFilters }}
  {{- range $key, $val := $context.Params }}
    {{- if and (ne $key "cited") (ne $key "authorNum") }}
      {{- $entryVal := index $entry $key }}

      {{- if reflect.IsSlice $entryVal }}
        {{- $found := false }}
        {{- range $entryVal }}
          {{- $elem := printf "%v" . }}
          {{- if in ($elem | lower) ($val | lower) }}
            {{- $found = true }}
          {{- end }}
        {{- end }}
        {{- if not $found }}
          {{- $include = false }}
        {{- end }}
      {{- else }}
        {{- $strVal := printf "%v" $entryVal }}
        {{- if not (in ($strVal | lower) ($val | lower)) }}
          {{- $include = false }}
        {{- end }}
      {{- end }}

    {{- end }}
  {{- end }}
{{- end }}
    <!-- adds entry to citations if it should be included based on filters and in-text citations -->
    {{- if and $include (or (not $onlyCited) (in $citedTitles $entry.title)) }}

            {{- $authors := slice }}
            {{- range $entry.creators }}                
                {{- if eq .creatorType "author" }}
                    {{- $firstInitial := "" }}
                    {{- if .firstName }}
                        {{- $firstInitial = printf "%s." (substr .firstName 0 1) }}
                    {{- end }}
                    {{- if .lastName }}
                        {{- $name := printf "%s, %s" .lastName $firstInitial }}
                        {{- $authors = $authors | append $name }}
                    {{- end }}
                {{- end }}
            {{- end }}

            {{- $authorStr := delimit $authors ", " }}
            {{- $shownAuthors := first $authorNum $authors }}
            {{- $authorList := delimit $shownAuthors ", " }}
            {{- if ge (len $authors) $authorNum }}
                {{- $authorStr = printf "%s et al." ($authorList) }}
            {{ else }}
                {{- $authorStr = $authorList }}
            {{- end }}
            {{- $citation := dict "authorStr" $authorStr "citation" $entry -}}
            {{- $citations = $citations | append $citation }}
    {{- end }}    
  {{ end }}
{{ end }}


{{$sortedCitations := sort $citations "authorStr" }}
{{$collections := site.Data.collections }}


{{- $singleCollection := false }}
{{- if $hasFilters }}
  {{- range $key, $val := $context.Params }}
    {{- if eq $key "collections" }}
      {{- $singleCollection = true }}
    {{- end }}
  {{- end }}
{{- end }}



<ul style="list-style-type: none;" class="apa-citation-list">
    {{- range $citation := $sortedCitations }}
        {{- partial "render-citation.html" . }}
        {{- $collections := $citation.citation.collections | default (slice) }}
        {{- if eq (len $collections) 0 }}
            {{- partial "render-citation.html" . }}
        {{- end }}
    {{- end }} 

    {{- range $collections }}
        {{ partial "render-collection.html" (dict "collection" . "citations" $sortedCitations "singleCollection" $singleCollection) }}
    {{- end }}
</ul>
