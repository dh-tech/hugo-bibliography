{{ $collection := .collection }}
{{ $allCitations := .citations }}
{{ $thisKey := $collection.key }}

<li>
  <h2>{{ $collection.name }}</h2>

    {{ range $citation := $allCitations }}
        {{ $colKeys := $citation.citation.collections | default (slice) }}
        {{ if in $colKeys $thisKey }}
            {{ partial "render-citation.html" $citation }}
        {{ end }}
    {{ end }}

  {{/* Render children recursively */}}
  {{ with $collection.children }}
      {{ range . }}
        {{ partial "render-collection.html" (dict "collection" . "citations" $allCitations) }}
      {{ end }}
  {{ end }}
</li>